name: ðŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸŒ Deploy to flowcab.fr
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ”§ Install dependencies
        run: pnpm install

      # Le build sera fait cÃ´tÃ© serveur avec les variables d'environnement locales

      - name: ðŸ“ Create deployment archive
        run: |
          # Utilisation de git archive pour Ã©viter complÃ¨tement les conflits tar
          # Ne prend que les fichiers suivis par git, aucun conflit possible
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git archive --format=tar --prefix=app/ HEAD | gzip > taxi-manager-deploy.tar.gz

      - name: ðŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ“¤ Deploy to server
        run: |
          # Configuration SSH
          ssh-keyscan -H 69.62.108.105 >> ~/.ssh/known_hosts
          
          # Transfer de l'archive
          scp taxi-manager-deploy.tar.gz root@69.62.108.105:~/taxi-manager-new.tar.gz
          
          # DÃ©ploiement sur le serveur
          ssh root@69.62.108.105 << EOF
            export NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
            export NEXT_PUBLIC_SUPABASE_URL="${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}"
            export NEXT_PUBLIC_SUPABASE_ANON_KEY="${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}"
            export SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
            set -e
            
            echo "ðŸš€ DÃ©but du dÃ©ploiement..."
            
            # Backup de l'ancienne version
            if [ -d "/var/www/app.flowcab.fr" ]; then
              cp -r /var/www/app.flowcab.fr /var/www/app.flowcab.fr.backup.$(date +%Y%m%d-%H%M%S)
            fi
            
            # CrÃ©ation du rÃ©pertoire temporaire
            mkdir -p /var/www/app.flowcab.fr.new
            cd /var/www/app.flowcab.fr.new
            
            # Extraction de la nouvelle version
            tar -xzf ~/taxi-manager-new.tar.gz --strip-components=1
            
            # CrÃ©ation des variables d'environnement production
            cat > .env.production.local << EOF
NODE_ENV=production
NEXTAUTH_URL=https://app.flowcab.fr
NEXTAUTH_SECRET=$NEXTAUTH_SECRET
NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY
EOF
            
            # Installation de toutes les dÃ©pendances
            pnpm install
            
            # Nettoyage du cache Next.js
            rm -rf .next
            
            # Build de production sur le serveur
            NODE_ENV=production pnpm build
            
            # LibÃ©rer le port 3000
            lsof -ti:3000 | xargs kill -9 || true
            
            # ArrÃªt de l'ancienne version
            pm2 stop taxi-manager || true
            
            # Correction des permissions avant remplacement
            chown -R root:root /var/www/app.flowcab.fr.new
            
            # Remplacement atomique
            if [ -d "/var/www/app.flowcab.fr" ]; then
              mv /var/www/app.flowcab.fr /var/www/app.flowcab.fr.old
            fi
            mv /var/www/app.flowcab.fr.new /var/www/app.flowcab.fr
            
            # Copie de la configuration PM2
            cd /var/www/app.flowcab.fr
            if [ ! -f "ecosystem.config.js" ]; then
              cp ~/ecosystem.config.js .
            fi
            
            # Relancement de l'application
            pm2 start ecosystem.config.js || pm2 restart taxi-manager
            pm2 save
            
            # Nettoyage
            rm -f ~/taxi-manager-new.tar.gz
            rm -rf /var/www/app.flowcab.fr.old
            
            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"
          EOF

      - name: ðŸ§ª Test deployment
        run: |
          sleep 10
          curl -f -L -I http://app.flowcab.fr || exit 1
          echo "âœ… Application accessible sur app.flowcab.fr"

      - name: ðŸ“§ Notify on failure
        if: failure()
        run: |
          echo "âŒ DÃ©ploiement Ã©chouÃ© - vÃ©rifiez les logs"