name: üöÄ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: üåç Deploy to flowcab.fr
    runs-on: ubuntu-latest

    steps:
      - name: üìÇ Checkout repository
        uses: actions/checkout@v4

      - name: üì• Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: üîß Install dependencies
        run: pnpm install

      # Le build sera fait c√¥t√© serveur avec les variables d'environnement locales

      - name: üìÅ Create deployment archive
        run: |
          # Utilisation de git archive pour √©viter compl√®tement les conflits tar
          # Ne prend que les fichiers suivis par git, aucun conflit possible
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git archive --format=tar HEAD | gzip > taxi-manager-deploy.tar.gz

      - name: üîë Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üì§ Deploy to server
        run: |
          set -Eeuo pipefail
          ssh-keyscan -H 69.62.108.105 >> ~/.ssh/known_hosts
          
          # Transfer archive et script
          scp taxi-manager-deploy.tar.gz root@69.62.108.105:/root/taxi-manager-new.tar.gz
          scp deploy/deploy-app.sh root@69.62.108.105:/root/deploy-app.sh
          
          # Cr√©ation du fichier env temporaire
          echo "NODE_ENV=production" > temp_env.txt
          echo "NEXTAUTH_URL=https://app.flowcab.fr" >> temp_env.txt
          echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> temp_env.txt
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" >> temp_env.txt
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" >> temp_env.txt
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> temp_env.txt
          
          # Transfer du fichier env
          scp temp_env.txt root@69.62.108.105:/root/temp_env.txt
          rm temp_env.txt
          
          # Ex√©cution du script de d√©ploiement
          ssh root@69.62.108.105 "chmod +x /root/deploy-app.sh && /root/deploy-app.sh"

      - name: üß™ Test deployment
        run: |
          sleep 10
          curl -f -L -I http://app.flowcab.fr || exit 1
          echo "‚úÖ Application accessible sur app.flowcab.fr"

      - name: üìß Notify on failure
        if: failure()
        run: |
          echo "‚ùå D√©ploiement √©chou√© - v√©rifiez les logs"